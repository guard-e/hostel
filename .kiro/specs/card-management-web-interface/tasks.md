# План реализации: Веб-интерфейс управления картами

## Обзор

Реализация веб-приложения для управления картами (пропусками) с использованием Flask, SQLAlchemy и Bootstrap 5. Приложение взаимодействует с базой данных Firebird через хранимую процедуру HOSTEL_CARDEDIT.

## Задачи

- [ ] 1. Настройка структуры проекта и зависимостей
  - Создать структуру каталогов проекта (app/, templates/, static/, tests/)
  - Создать requirements.txt с зависимостями (Flask, SQLAlchemy, fdb, pytest, hypothesis)
  - Настроить конфигурацию Flask приложения (app.py)
  - _Требования: 11.1, 11.2_

- [ ] 2. Реализация DatabaseManager для работы с Firebird
  - [ ] 2.1 Создать класс DatabaseManager с методами подключения
    - Реализовать методы connect(), disconnect()
    - Настроить работу с драйвером fdb для Firebird
    - _Требования: 5.4, 10.3_
  
  - [ ] 2.2 Реализовать метод вызова процедуры HOSTEL_CARDEDIT
    - Создать метод call_cardedit_procedure() с параметрами (action, room, card_number, valid_from, valid_days, comments, dep)
    - Обработать выходные параметры (O_PEOPLEID, O_PROFILEID, O_CARDID, O_RES, O_ACTIVED, O_FROM, O_TO)
    - _Требования: 5.1, 5.2_
  
  - [ ] 2.3 Реализовать метод вызова процедуры UPD_DUMPS
    - Создать метод call_upd_dumps() для обновления дампов после операций с картой
    - _Требования: 5.1_
  
  - [ ] 2.4 Реализовать метод получения списка карт
    - Создать метод get_all_cards() для получения записей из таблиц CARDS, PEOPLE, DEP
    - Фильтровать записи по критерию (например, по отделу "ХОСТЕЛ")
    - _Требования: 4.1_
  
  - [ ] 2.5 Реализовать метод аутентификации пользователей
    - Создать метод authenticate_user() для проверки учетных данных через таблицу USERS
    - Анализировать поля FLAGS и SFLAGS для определения прав доступа
    - _Требования: 9.3, 9.4, 9.5_
  
  - [ ] 2.6 Написать property-тест для вызова процедуры HOSTEL_CARDEDIT
    - **Property 11: Корректность параметров процедуры**
    - **Validates: Requirements 5.2**

- [ ] 3. Реализация модели данных Card
  - [ ] 3.1 Создать класс Card с атрибутами
    - Определить атрибуты: people_id, card_id, room, card_number, valid_from, valid_until, status, comments
    - Реализовать методы to_dict() и from_dict()
    - _Требования: 1.1, 2.1_
  
  - [ ] 3.2 Реализовать валидацию данных карты
    - Создать метод validate() с проверками: room > 0, card_number > 0, valid_until > valid_from
    - Вернуть кортеж (is_valid, errors)
    - _Требования: 6.2, 6.3_
  
  - [ ] 3.3 Реализовать метод parse_room для разбора номера комнаты
    - Создать статический метод parse_room() для формата (X)XYY
    - Вернуть кортеж (floor, room_number)
    - _Требования: 1.1_
  
  - [ ] 3.4 Написать unit-тесты для валидации Card
    - Тестировать граничные случаи: пустые поля, некорректные даты, отрицательные числа
    - _Требования: 6.2_
  
  - [ ] 3.5 Написать property-тест для валидации невалидных данных
    - **Property 2: Отклонение невалидных данных при создании**
    - **Validates: Requirements 1.2**
  
  - [ ] 3.6 Написать property-тест для round-trip сериализации
    - **Property 4: Round-trip для редактирования карты**
    - **Validates: Requirements 2.1**

- [ ] 4. Реализация AuthManager для управления сессиями
  - [ ] 4.1 Создать класс AuthManager с методами аутентификации
    - Реализовать статические методы: login_user(), logout_user(), is_authenticated()
    - Использовать Flask session для хранения данных пользователя
    - _Требования: 9.6, 9.7, 9.8_
  
  - [ ] 4.2 Реализовать метод проверки прав доступа
    - Создать метод check_permissions() для анализа FLAGS и SFLAGS
    - Вернуть словарь с правами: can_create, can_edit, can_delete, can_view
    - _Требования: 9.5_
  
  - [ ] 4.3 Написать property-тест для аутентификации
    - **Property 19: Создание сессии при успешной аутентификации**
    - **Validates: Requirements 9.6**
  
  - [ ] 4.4 Написать property-тест для отказа в доступе
    - **Property 20: Отказ в доступе при неудачной аутентификации**
    - **Validates: Requirements 9.7**

- [ ] 5. Контрольная точка - Проверка базовых компонентов
  - Убедиться, что все базовые классы (DatabaseManager, Card, AuthManager) работают корректно
  - Запустить unit-тесты и property-тесты
  - Спросить пользователя, если возникли вопросы

- [ ] 6. Реализация Flask routes для операций с картами
  - [ ] 6.1 Создать route для главной страницы (GET /)
    - Проверить аутентификацию пользователя
    - Перенаправить на /select-database или /login, если не авторизован
    - Отобразить главную страницу со списком карт
    - _Требования: 4.1, 9.1_
  
  - [ ] 6.2 Создать route для получения списка карт (GET /cards)
    - Вызвать db_manager.get_all_cards()
    - Вернуть JSON с массивом карт
    - _Требования: 4.1, 4.2_
  
  - [ ] 6.3 Создать route для создания карты (POST /cards)
    - Валидировать входные данные
    - Вызвать db_manager.call_cardedit_procedure() с action=1
    - Вызвать db_manager.call_upd_dumps()
    - Вернуть JSON с результатом
    - _Требования: 1.1, 1.2, 5.1_
  
  - [ ] 6.4 Создать route для получения данных карты (GET /cards/<id>)
    - Вызвать db_manager.call_cardedit_procedure() с action=0
    - Вернуть JSON с данными карты
    - _Требования: 2.1_
  
  - [ ] 6.5 Создать route для обновления карты (PUT /cards/<id>)
    - Валидировать входные данные
    - Вызвать db_manager.call_cardedit_procedure() с action=1
    - Вызвать db_manager.call_upd_dumps()
    - Вернуть JSON с результатом
    - _Требования: 2.2, 2.3_
  
  - [ ] 6.6 Создать route для удаления карты (DELETE /cards/<id>)
    - Вызвать db_manager.call_cardedit_procedure() с action=2
    - Вызвать db_manager.call_upd_dumps()
    - Вернуть JSON с результатом
    - _Требования: 3.2, 3.3_
  
  - [ ] 6.7 Написать property-тест для создания карты
    - **Property 1: Создание карты с валидными данными**
    - **Validates: Requirements 1.1, 1.3**
  
  - [ ] 6.8 Написать property-тест для обновления карты
    - **Property 5: Сохранение изменений карты**
    - **Validates: Requirements 2.2, 2.3**
  
  - [ ] 6.9 Написать property-тест для удаления карты
    - **Property 6: Удаление карты**
    - **Validates: Requirements 3.2, 3.3**

- [ ] 7. Реализация routes для аутентификации и выбора БД
  - [ ] 7.1 Создать route для выбора файла БД (GET /select-database)
    - Отобразить страницу с формой выбора файла guardee.fdb
    - _Требования: 10.1_
  
  - [ ] 7.2 Создать route для обработки выбора БД (POST /select-database)
    - Сохранить путь к файлу в сессии
    - Проверить подключение к БД
    - Перенаправить на /login при успехе или показать ошибку
    - _Требования: 10.2, 10.3, 10.4, 10.5_
  
  - [ ] 7.3 Создать route для страницы входа (GET /login)
    - Отобразить форму с полями username и password
    - _Требования: 9.2_
  
  - [ ] 7.4 Создать route для обработки входа (POST /login)
    - Вызвать auth_manager.login_user()
    - Создать сессию при успехе или показать ошибку
    - _Требования: 9.3, 9.4, 9.5, 9.6, 9.7_
  
  - [ ] 7.5 Создать route для выхода (GET /logout)
    - Вызвать auth_manager.logout_user()
    - Перенаправить на /select-database
    - _Требования: 9.8_
  
  - [ ] 7.6 Написать property-тест для проверки авторизации
    - **Property 21: Проверка авторизации для защищенных страниц**
    - **Validates: Requirements 9.8**
  
  - [ ] 7.7 Написать property-тест для сохранения пути к БД
    - **Property 22: Сохранение пути к базе данных в сессии**
    - **Validates: Requirements 10.2**

- [ ] 8. Реализация обработки ошибок
  - [ ] 8.1 Создать глобальный обработчик ошибок Flask
    - Реализовать @app.errorhandler для 400, 401, 403, 404, 500
    - Логировать ошибки с использованием Python logging
    - _Требования: 8.3_
  
  - [ ] 8.2 Реализовать обработку ошибок базы данных
    - Перехватывать исключения SQLAlchemy и fdb
    - Преобразовывать технические ошибки в понятные сообщения
    - _Требования: 8.1, 8.2, 8.4_
  
  - [ ] 8.3 Реализовать обработку ошибок процедуры HOSTEL_CARDEDIT
    - Анализировать коды результата (O_RES: 0, 1, 2, 3)
    - Возвращать соответствующие HTTP-коды и сообщения
    - _Требования: 5.3_
  
  - [ ] 8.4 Написать property-тест для обработки ошибок процедуры
    - **Property 12: Обработка ошибок процедуры**
    - **Validates: Requirements 5.3, 8.2, 8.4**
  
  - [ ] 8.5 Написать unit-тесты для граничных случаев
    - Тестировать: потеря соединения, таймауты, SQL-инъекции, XSS-атаки
    - _Требования: 8.1, 8.2_

- [ ] 9. Контрольная точка - Проверка backend
  - Убедиться, что все routes работают корректно
  - Запустить все тесты (unit и property)
  - Проверить обработку ошибок
  - Спросить пользователя, если возникли вопросы

- [ ] 10. Реализация frontend - HTML шаблоны
  - [ ] 10.1 Создать базовый шаблон (base.html)
    - Подключить Bootstrap 5 CDN
    - Создать навигацию и footer
    - Определить блоки для контента
    - _Требования: 7.1, 11.3_
  
  - [ ] 10.2 Создать шаблон главной страницы (index.html)
    - Создать таблицу для отображения карт
    - Добавить кнопки "Добавить", "Редактировать", "Удалить"
    - Создать модальное окно для формы карты
    - _Требования: 4.1, 4.2, 4.3, 7.1_
  
  - [ ] 10.3 Создать шаблон выбора БД (select_database.html)
    - Создать форму выбора файла guardee.fdb
    - Добавить инструкции для пользователя
    - _Требования: 10.1_
  
  - [ ] 10.4 Создать шаблон входа (login.html)
    - Создать форму с полями username и password
    - Добавить обработку сообщений об ошибках
    - _Требования: 9.2_

- [ ] 11. Реализация frontend - JavaScript логика
  - [ ] 11.1 Создать функцию загрузки списка карт (loadCards)
    - Выполнить AJAX GET-запрос к /cards
    - Отобразить карты в таблице
    - Добавить индикатор загрузки
    - _Требования: 4.1, 4.4, 7.4_
  
  - [ ] 11.2 Создать функцию отображения формы добавления (showAddCardForm)
    - Очистить форму
    - Открыть модальное окно
    - _Требования: 1.4_
  
  - [ ] 11.3 Создать функцию отображения формы редактирования (showEditCardForm)
    - Выполнить AJAX GET-запрос к /cards/<id>
    - Заполнить форму данными карты
    - Открыть модальное окно
    - _Требования: 2.1_
  
  - [ ] 11.4 Создать функцию сохранения карты (saveCard)
    - Выполнить клиентскую валидацию
    - Выполнить AJAX POST или PUT-запрос
    - Обновить список карт при успехе
    - Показать сообщение об успехе или ошибке
    - _Требования: 1.1, 1.2, 2.2, 6.1, 6.4_
  
  - [ ] 11.5 Создать функцию удаления карты (deleteCard)
    - Показать диалог подтверждения
    - Выполнить AJAX DELETE-запрос при подтверждении
    - Обновить список карт при успехе
    - _Требования: 3.1, 3.2, 3.4_
  
  - [ ] 11.6 Создать функцию клиентской валидации (validateCardForm)
    - Проверить обязательные поля
    - Проверить корректность дат
    - Показать сообщения об ошибках рядом с полями
    - Предотвратить отправку формы при ошибках
    - _Требования: 6.1, 6.3, 6.4_
  
  - [ ] 11.7 Создать функцию отображения сообщений (showMessage)
    - Показать Bootstrap alert с сообщением
    - Поддержать типы: success, error, warning, info
    - _Требования: 1.3, 2.3, 3.3, 7.2_
  
  - [ ] 11.8 Написать property-тест для клиентской валидации
    - **Property 13: Клиентская валидация предотвращает отправку**
    - **Validates: Requirements 6.1, 6.4**
  
  - [ ] 11.9 Написать property-тест для отображения всех карт
    - **Property 8: Отображение всех карт с атрибутами**
    - **Validates: Requirements 4.1, 4.2**

- [ ] 12. Реализация CSS стилей
  - [ ] 12.1 Создать custom.css для дополнительных стилей
    - Стилизовать таблицу карт
    - Стилизовать формы и кнопки
    - Добавить анимации для индикаторов загрузки
    - _Требования: 7.1, 7.2, 7.4_

- [ ] 13. Интеграция и финальное тестирование
  - [ ] 13.1 Интегрировать все компоненты
    - Подключить routes к app.py
    - Подключить JavaScript к шаблонам
    - Настроить статические файлы
    - _Требования: 11.1, 11.2, 11.3, 11.4_
  
  - [ ] 13.2 Написать интеграционные тесты для CRUD операций
    - Тестировать полный цикл: создание → чтение → обновление → удаление
    - _Требования: 1.1, 2.2, 3.2, 4.1_
  
  - [ ] 13.3 Написать интеграционные тесты для аутентификации
    - Тестировать полный flow: выбор БД → вход → операции → выход
    - _Требования: 9.1, 9.2, 9.6, 9.8, 10.1_
  
  - [ ] 13.4 Написать property-тест для синхронизации списка
    - **Property 10: Синхронизация списка с базой данных**
    - **Validates: Requirements 4.4**
  
  - [ ] 13.5 Написать property-тест для очистки формы
    - **Property 3: Очистка формы после операции**
    - **Validates: Requirements 1.4**

- [ ] 14. Финальная контрольная точка
  - Запустить все тесты (unit, property, integration)
  - Проверить покрытие кода (минимум 80% для backend)
  - Проверить работу приложения вручную
  - Убедиться, что все требования выполнены
  - Спросить пользователя, если возникли вопросы

## Примечания

- Задачи, помеченные `*`, являются опциональными и могут быть пропущены для более быстрого создания MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Контрольные точки обеспечивают инкрементальную валидацию
- Property-тесты проверяют универсальные свойства корректности
- Unit-тесты проверяют конкретные примеры и граничные случаи
- Минимум 100 итераций для каждого property-теста
